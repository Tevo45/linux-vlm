;;; -*- Mode: LISP; Syntax: Common-Lisp; Package: POWERPC-INTERNALS; Base: 10; Lowercase: T -*-

(in-package "POWERPC-INTERNALS")

;;; Macros in support of block instructions.  These are mostly in IFUNBLOK.PPCS


(assert (lisp:and (< (integer-length processorstate$q-bar0) 15)
		  (< (integer-length processorstate$q-bar1) 15)
		  (< (integer-length processorstate$q-bar2) 15)
		  (< (integer-length processorstate$q-bar3) 15))
	()
	"The BAR registers have an offset of more than 15 bits")

;;; Note well!  We always store the updated VMA back into the BAR, even
;;; in the no-increment case.  This is because the BAR must get the result
;;; of having followed forwarding pointers.

;;; Note well!  We always store the updated VMA back into the BAR, even
;;; in the no-increment case.  This is because the BAR must get the result
;;; of having followed forwarding pointers.

(defmacro i%block-n-read (bar op vma tag data cycle temp3 temp4 temp5 temp6 temp9 temp10 temp11 temp12)
  (check-temporaries (bar op) (cycle vma temp3 temp4 temp5 temp6 data tag temp9 temp10 temp11 temp12))
  (let ((fntest (gensym))
	(sk (gensym))
	(sk1 (gensym))
	(nofntest (gensym))
	(ielab (gensym)))
    (push
      `((label ,fntest)
	(CheckDataType ,tag |TypeFixnum| ,ielab ,temp9)
	(B ,nofntest))
      *function-epilogue*)
    `((LWA ,vma 4 (,bar) "Get the vma")
      (srdi ,cycle ,op 6 "cycle type")
      (ANDI-DOT ,temp4 ,op 4 "=no-incrementp")
      ;;; we don't care about last-word
      (ANDI-DOT ,temp5 ,op 16 "=cdr-code-nextp")
      (ANDI-DOT ,temp6 ,op 32 "=fixnum onlyp")
      (clrldi ,vma ,vma 32)
      (comment "Do the read cycle")
      (memory-read ,vma ,tag ,data ,cycle ,temp9 ,temp10 ,temp11 ,temp12 nil t)
      (branch-if-nonzero ,temp6 ,fntest "J. if we have to test for fixnump.")
      (unlikely-label ,nofntest)
      (ADDI ,temp6 ,vma 1 "Compute Incremented address")
      (force-alignment)
      (CMPI 0 1 ,temp4 0)
      (BC 4 2 ,sk "B.NE")
      (mov ,vma ,temp6 "Conditionally update address")
    (unlikely-label ,sk)
      (STW ,vma 4 (,bar) "Store updated vma in BAR")
      (ANDI-DOT ,temp4 ,tag #x3F "Compute CDR-NEXT")
      (GetNextPC)
      (CMPI 0 1 ,temp5 0)
      (BC 12 2 ,sk1 "B.EQ")
      (mov ,tag ,temp4 "Conditionally Set CDR-NEXT")
    (unlikely-label ,sk1)
      (GetNextCP)
      (stack-push2-with-cdr ,tag ,data)
      (ContinueToNextInstruction-NoStall)
      (label ,ielab)
      (illegal-operand block-read-transport-and-fixnum-type-check ,vma "Not a fixnum"))))

(defmacro i%block-n-write (bar-register bar-vma data temp2 temp3 temp4 temp5 temp6 temp7 temp8 temp9)
  (check-temporaries (bar-register bar-vma data) (temp2 temp3 temp4 temp5 temp6 temp7 temp8))
  `((srdi ,temp3 ,data 32 "Get tag")
    (clrldi ,temp4 ,data 32 "Get data")
    (memory-write ,bar-vma ,temp3 ,temp4 PROCESSORSTATE_RAW ,temp9 ,temp5 ,temp6 ,temp7 ,temp8)
    (GetNextPCandCP)
    (ADDI ,bar-vma ,bar-vma 1 "Increment the address")
    ;; Can't side-effect the BAR until after the write in case it would trap.
    (STW ,bar-vma 4 (,bar-register) "Store updated vma in BAR")
    (ContinueToNextInstruction-NoStall)))

(defmacro i%block-n-read-shift (bar op temp temp2 temp3 temp4 temp5 temp6 temp7 temp8 temp9 temp10 temp11 temp12)
  (check-temporaries (bar op) (temp temp2 temp3 temp4 temp5 temp6 temp7 temp8 temp9 temp10 temp11 temp12))
  (let ((nofntest (gensym))
	(noincp (gensym))
	(noclrcdr (gensym))
	(ielab (gensym)))
    `((LWA ,temp2 4 (,bar) "Get the vma")
      (srdi ,temp ,op 6 "cycle type")
      (ANDI-DOT ,temp4 ,op 4 "=no-incrementp")
      ;;; we don't care about last-word
      (ANDI-DOT ,temp5 ,op 16 "=cdr-code-nextp")
      (ANDI-DOT ,temp6 ,op 32 "=fixnum onlyp")
      (clrldi ,temp2 ,temp2 32)
      (memory-read ,temp2 ,temp8 ,temp7 ,temp ,temp9 ,temp10 ,temp11 ,temp12)
      (branch-if-zero ,temp6 ,nofntest "J. if we don't have to test for fixnump.")
      (CheckDataType ,temp8 |TypeFixnum| ,ielab ,temp9)
    (label ,nofntest)
      (branch-if-nonzero ,temp4 ,noincp "J. if we don't have to increment the address.")
      (ADDI ,temp2 ,temp2 1 "Increment the address")
    (label ,noincp)
      (STW ,temp2 4 (,bar) "Store updated vma in BAR")
      (branch-if-zero ,temp5 ,noclrcdr "J. if we don't have to clear CDR codes.")
      (ANDI-DOT ,temp8 ,temp8 #x3F)
    (label ,noclrcdr)
      (load-constant ,temp #.(sys:%logdpb
			       (sys:%alu-function-dpb sys:%alu-byte-background-rotate-latch
						      sys:%alu-byte-set-rotate-latch)
			       sys:%%alu-function 0)
		     "Create a fake ALU control register")
      (alu-function-byte ,temp ,temp ,temp7 ,temp7 ,temp2 ,temp3 ,temp4 ,temp5 ,temp6)
      (GetNextPCandCP)
      (stack-push2-with-cdr ,temp8 ,temp7)
      (ContinueToNextInstruction-NoStall)
    (label ,ielab)
      (illegal-operand block-read-transport-and-fixnum-type-check ,temp2 "Not a fixnum"))))

(defmacro i%block-n-read-alu (bar addr temp temp2 temp3 temp4 temp5 temp6 temp7 temp8 temp9 temp10 temp11 temp12)
  (check-temporaries (bar addr) (temp temp2 temp3 temp4 temp5 temp6 temp7 temp8 temp9 temp10 temp11 temp12))
  (let ((ielab2 (gensym))
	(ielab1 (gensym))
	(op1tag temp2)
	(op1data temp3)
	(op2tag temp4)
	(op2data temp5)
	(aluop temp6)
	(control temp7)
	(result temp8))
    `((LWA ,temp 4 (,bar) "Get the vma")
      (stack-read2 ,addr ,op2tag ,op2data)
      (CheckDataType ,op2tag |TypeFixnum| ,ielab2 ,temp9)
      (clrldi ,temp ,temp 32)
      (memory-read ,temp ,op1tag ,op1data PROCESSORSTATE_DATAREAD ,temp9 ,temp10 ,temp11 ,temp12)
      (CheckDataType ,op1tag |TypeFixnum| ,ielab1 ,temp9)
      (ADDI ,temp ,temp 1 "Increment the address")
      (STW ,temp 4 (,bar) "Store updated vma in BAR")
      (LD ,aluop PROCESSORSTATE_ALUOP (ivory))
      (stzd PROCESSORSTATE_ALUOVERFLOW (ivory))
      (LD ,control PROCESSORSTATE_ALUANDROTATECONTROL (ivory))
      (basic-dispatch ,aluop ,temp
	(|ALUFunctionBoolean| 
	  (alu-function-boolean ,control ,result ,op1data ,op2data ,temp)
	  (stack-write-data ,addr ,result)
	  (ContinueToNextInstruction))
	(|ALUFunctionByte|
	  (alu-function-byte ,control ,op1data ,op2data ,result ,temp ,temp9 ,temp10 ,temp11 ,temp12)
	  (stack-write-data ,addr ,result)
	  (ContinueToNextInstruction))
	(|ALUFunctionAdder|
	  (alu-function-adder ,control ,op1data ,op2data ,result ,temp ,temp9 ,temp10 ,temp11)
	  (stack-write-data ,addr ,result)
	  (ContinueToNextInstruction))
	(|ALUFunctionMultiplyDivide|
	  (alu-function-multiply-divide ,control ,op1data ,op2data ,result ,temp ,temp9)
	  (stack-write-data ,addr ,result)
	  (ContinueToNextInstruction)))
    (label ,ielab2)
      (SCAtoVMA ,addr ,temp ,temp9)
      (illegal-operand block-read-transport-and-fixnum-type-check ,temp "Not a fixnum")
    (label ,ielab1)
      (illegal-operand block-read-transport-and-fixnum-type-check ,temp "Not a fixnum"))))

(defmacro i%block-n-read-test (bar op vma temp temp2 temp3 temp4 temp5 temp6 temp7 temp8 temp9 temp10 temp11 temp12)
  (check-temporaries (bar op) (temp temp2 temp3 temp4 temp5 temp6 temp7 temp8 temp9 temp10 temp11 temp12))
  (let ((nofntest (gensym))
	(noincp (gensym))
	(noclrcdr (gensym))
	(ielab1 (gensym))
	(ielab2 (gensym))
	(taken (gensym))
	(op1tag temp2 )
	(op1data temp3)
	(op2tag temp4)
	(op2data temp5)
	(aluop temp6)
	(control temp7)
	(result temp8))
    `((LWA ,vma 4 (,bar) "Get the vma")
      (srdi ,temp ,op 6 "cycle type")
      (stack-read2 iSP ,op2tag ,op2data)
      (clrldi ,vma ,vma 32)
      (memory-read ,vma ,op1tag ,op1data ,temp ,temp9 ,temp10 ,temp11 ,temp12)
      (ANDI-DOT ,temp ,op 32 "=fixnum onlyp")
      (branch-if-zero ,temp ,nofntest "J. if we don't have to test for fixnump.")
      (CheckDataType ,op1tag |TypeFixnum| ,ielab1 ,temp9)
      (CheckDataType ,op2tag |TypeFixnum| ,ielab2 ,temp9)
    (label ,nofntest)
      (ANDI-DOT ,temp ,op 16 "=cdr-code-nextp")
      (branch-if-zero ,temp ,noclrcdr "J. if we don't have to clear CDR codes.")
      (TagType ,op1tag ,op1tag)
    (label ,noclrcdr)
      (LD ,aluop PROCESSORSTATE_ALUOP (ivory))
      (stzd PROCESSORSTATE_ALUOVERFLOW (ivory))
      (LD ,control PROCESSORSTATE_ALUANDROTATECONTROL (ivory))
      (basic-dispatch ,aluop ,temp
	(|ALUFunctionBoolean| 
	  (alu-function-boolean ,control ,result ,op1data ,op2data ,temp))
	(|ALUFunctionByte|
	  (alu-function-byte ,control ,op1data ,op2data ,result ,temp ,temp9 ,temp10 ,temp11 ,temp12))
	(|ALUFunctionAdder|
	  (alu-function-adder ,control ,op1data ,op2data ,result ,temp ,temp9 ,temp10 ,temp11))
	(|ALUFunctionMultiplyDivide|
	  (alu-function-multiply-divide ,control ,op1data ,op2data ,result ,temp ,temp9)))
      (alu-compute-condition ,control ,op1tag ,op2tag ,result ,temp ,temp9 ,temp10 ,temp11 ,temp12)
      (branch-true ,temp ,taken)
      (ANDI-DOT ,temp ,op 4 "=no-incrementp")
      (branch-if-nonzero ,temp ,noincp "J. if we don't have to increment the address.")
      (ADDI ,vma ,vma 1 "Increment the address")
    (label ,noincp)
      (STW ,vma 4 (,bar) "Store updated vma in BAR")
      (ContinueToNextInstruction)      
    (label ,taken)
      (stack-read2-disp iSP -8 ,temp9 ,temp10)
      #+++ignore (CheckAdjacentDataTypes ,temp9 |TypeEvenPC| 2 ,except ,temp10)
      (sldi ,temp10 ,temp10 1)
      (ANDI-DOT iPC ,temp9 1)
      (ADD iPC iPC ,temp10)
      (B InterpretInstructionForJump)
    (label ,ielab2)
      (SCAtoVMA iSP ,vma ,temp9)
      (illegal-operand block-read-transport-and-fixnum-type-check ,vma "Not a fixnum")
    (label ,ielab1)
      (illegal-operand block-read-transport-and-fixnum-type-check ,vma "Not a fixnum")))) 

;;; Fin.
